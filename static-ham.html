<!DOCTYPE html>
<meta charset="utf-8">
<!-- references: https://bl.ocks.org/mbostock/3886208 -->
<head>
    <link rel="stylesheet" type="text/css" href="themes.css">
</head>

<body>
    <h1> Lyrical Themes in Hamilton </h1>
    <div id="themes-list"></div>
    <div id="vis_container">
        <div id="div1">  </div>
        <div id="info_panel_1"> </div>
        <div id="div2"> </div>
        
        <div id="info_panel"> </div>
    </div>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script>

    d3.csv("output.csv", function(data) {

    var unique_themes = [];
    data.forEach(function(datum) {
        // console.log(datum.theme_name);
        if (unique_themes.indexOf(datum.theme_name) == -1 && datum.theme_name != "none") {
            unique_themes.push(datum.theme_name);
        }
    });
    // console.log(unique_themes);
    console.log("numthemes: ", unique_themes.length);

    var unique_songs = [];
    var songs = [];
    data.forEach(function(datum) {
        if (unique_songs.indexOf(datum.song_number) == -1 && datum.song_number != "") {
            unique_songs.push(datum.song_number);
            songs.push([datum.song_name, parseInt(datum.song_number, 10), parseInt(datum.total_start_sec, 10)]);
        }
    });

   var numSongs = songs.length;
   console.log("numSongs: ", numSongs);
   var current_color;
   var num_clips = 0;

    function print_themes(unique_themes) {
        var current_theme;
        for (var i = 0; i < unique_themes.length; i++) {
            d3.select("#themes-list")
                .append("div")
                    .on('mouseenter', function(d){
                        current_theme = this.textContent;
                        console.log(current_theme);

                        // find rects that have this theme and elongate_bar
                        d3.selectAll("rect").each(function(d, i){
                            if(d3.select(this).attr("theme") == current_theme){ 
                                num_clips++;
                                current_color = color(d.theme_name);
                                elongate_bar(d, data, svg, false); 
                                hover_display(d, this.parentNode.id, "#div1");          
                            }
                        })

                        this.style.backgroundColor = current_color;

                    })
                
                    .on('mouseleave', function(d) {
                        num_clips = 0;
                        this.style.backgroundColor = "#EEEEEE";
                        d3.selectAll("rect").each(function(d, i){
                            if(d3.select(this).attr("theme") == current_theme){ 
                                reset_bar(d, data, svg, false);         
                            }
                        })
                    })
                .attr("class", "theme-item")
                .text(unique_themes[i]);
        }
    }
    // print_themes(unique_themes);


    //setup 
    var window_change_height = 50;

    var barHeight = 40;

    var panel_showing = false;

    var panel_num = -1;

    var highlighted_theme;

    var standard_y = 10;

    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = window.innerWidth - 100,
        height = 100;


    //scaling
    var x = d3.scale.linear()
        .rangeRound([0, width]);

    x.domain([0, d3.max(data, function(d) { return parseInt(d.total_start_sec, 10) + parseInt(d.length_sec, 10); })]);


    var songx = d3.scale.linear()
        .rangeRound([0, width * .4]);

    songx.domain([0, d3.max(data, function(d) { return parseInt(d.length_sec, 10); })]);


    var color = d3.scale.ordinal()
        // .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
        .range(["#444444", "#400000", "#cc6666", "#cc8166", "#4d3e39", "#4c1f00", "#f2853d", "#8c5b23", "#e5b073", "#ffaa00", "#332900", "#fff240", "#737156", "#adb359", "#6df23d", "#d0ffbf", "#1f5916", "#269954", "#1a3324", "#7ca692", "#39e6c3", "#00474d", "#39c3e6", "#004d73", "#40a6ff", "#001433", "#3056bf", "#737899", "#140099", "#5940ff", "#ff0044", "#8c0025", "#8c235b"]); 
        // http://phrogz.net/css/distinct-colors.html
    color.domain(d3.keys(data.theme_name));


    var x_pos_whole_musical = function(d) {
        // console.log("place: ", x(parseInt(d.total_start_sec, 10)));
      return x(parseInt(d.total_start_sec, 10));
    };

    var x_pos_by_song = function(d) {
      return songx(parseInt(d.start_sec, 10));
    };

    var y_pos_by_song = function(d) {
        // var h = (parseInt(d.song_number, 10) - 1 );
        // // if (panel_showing && panel_num < d.song_number) {
        // //     h += 100;
        // // }
        // console.log("Logging: ", d.song_number);
        return 10;  
    };

    // var y_text_pos_by_song = function(d) {
    //     var h = d[1]*100 - 5;
    //     if (panel_showing && panel_num < d[1]) {
    //         h += 100;
    //     }
    //     return h;    
    // };

    var width_of_theme = function(d) {
      return x(parseInt(d.length_sec, 10)+1);
    };

    var width_of_theme_by_song = function(d) {
      return songx(parseInt(d.length_sec, 10)+1);
    };


    var y_pos_by_change = function(d, w) {
        // console.log((w - window_change_height)/100);
        // console.log(d[7] * height/(w - window_change_height));
        return d.song_number * (w - window_change_height);
    }


    function elongate_bar(d, data, svg, songs) {
            svg.selectAll("rect")
                .attr("class", "update")
                .transition()
                    .duration(750)
                        .attr("height", function(d1) {
                            if (d1.theme_name == d.theme_name && d.theme_name != "none") {
                                return barHeight + 20;
                            } else {
                                return barHeight;
                            }
                        })
                        .attr("y", function(d1) {
                            if (d1.theme_name == d.theme_name && d.theme_name != "none") {
                                if (songs) {
                                    return y_pos_by_song(d1) - 10;
                                }
                                return standard_y - 10; 
                            } else {
                                if (songs) {
                                    return y_pos_by_song(d1);
                                }
                                return standard_y;                             
                            }
                        });
    }

    function reset_bar(d, data, svg, songs) {
        svg.selectAll("rect")
            .attr("class", "update")
            .transition()
                .duration(750)
                    .attr("height", barHeight)
                    .attr("y", function(d1) {
                        if (songs) {
                            return y_pos_by_song(d1);
                        }
                        return standard_y; 
                    });
    }


    function hover_display(d, pid, div_id) {
        // console.log(d.theme_name);
        panel_showing = true;
        panel_num = d.song_number;

        //get rid of the old panel
        d3.select(".info_panel")
            .remove();

        var yoff = 70;
        // if (!transition_to_split) {
        //     yoff = (panel_num * 100) + 50;
        //  }

        if (d.theme_name != "none") {
            //insert a new panel
            var ip = d3.select("#info_panel_1")
                .append("div")
                    .attr("class", "info_panel")
                    .html('Theme: ' + d.theme_name + ' | ' + 'Song: "' + d.song_name + '"' + "<br/>" +'This theme appears ' + num_clips + ' times');



            ip.append("br");
            ip.append("br");

            ip.append("audio")
                .attr("class", "audio-player")
                .attr("src", d.song_url + "#t=" + d.start_sec + "," + d.end_sec + 1)
                .attr("controls", "")
                .text("Your browser does not support the <code>audio</code> element");

            ip.append("p");

            ip.append("test")
                .text("Lyrics:");

        }

    };

    //display data, starting in a single bar for the whole musical
    var svg = d3.select("#div1").append("svg")
        .attr("width", width)
        .attr("height", height)
    

        var g = svg.append("g")
            .attr("id", "g" + ns)
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        g.selectAll("rect")
            .data(data)
          .enter().append("rect")
            .attr("class", "enter")
            .attr("theme", function(d) { return d.theme_name; })
            .attr("width", function(d) {return width_of_theme(d);})
            .attr("x", function(d) { return x_pos_whole_musical(d); })
            .attr("y", standard_y)
            .attr("height", function(d) { return barHeight; })
            .style("fill", function(d) { return color(d.theme_name); })
            .on('mouseenter', function(d){
                elongate_bar(d, data, svg, false);
                hover_display(d, this.parentNode.id, "#div1");
                // console.log(this.parentNode.id);
            })
            .on('mouseleave', function(d) {
                reset_bar(d, data, svg, false);
            });
        
        g.selectAll("text")
            .data(songs)
          .enter().append("text")
            .attr("x", function(d) { return x(parseInt(d[2], 10)); })
            .attr("y", function(d) { return (standard_y-15); } )
            .text(function(d) { return d[1];} );


// display data, split by songs
    for (var ns = 1; ns <= numSongs; ns++) {
        var svg_songs = d3.select("#div2").append("svg")
            .attr("width", width)
            .attr("height", height);

        var g2 = svg_songs.append("g")
            .attr("id", "g" + ns)
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        g2.selectAll("rect")
            .data(data)
          .enter()
            .append("rect")
            .filter(function(d) { 
              return d.song_number == ns;
            })
            .attr("class", "enter")
            .attr("theme", function(d) { return d.theme_name; })
            .attr("width", function(d) {return width_of_theme_by_song(d);})
            .attr("x", function(d) { return x_pos_by_song(d); })
            .attr("y", function(d) { return y_pos_by_song(d); })
            .attr("height", function(d) { return barHeight; })
            .style("fill", function(d) { return color(d.theme_name); });
            // .on('mouseenter', function(d){
            //     elongate_bar(d, data, svg_songs, true);
            //     hover_display(d, this.parentNode.id, "#div2");
            //     console.log(this.parentNode.id, "#div2");
            // })
            // .on('mouseleave', function(d) {
            //     reset_bar(d, data, svg_songs, true);
            // });

        g2.selectAll("text")
            .data(songs)
          .enter().append("text")
            .filter(function(d) {
                return d[1] == ns;
            })
            .attr("x", function(d) { return 0; })
            .attr("y", function(d) { return y_pos_by_song(d)-15; })
            .text(function(d) { return d[0] ;});
    }
});
    </script>
</body>
