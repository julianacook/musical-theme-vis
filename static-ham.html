<!DOCTYPE html>
<meta charset="utf-8">
<!-- references: https://bl.ocks.org/mbostock/3886208 -->
<head>
    <link rel="stylesheet" type="text/css" href="themes.css">
</head>

<body>
    <h1> Lyrical Themes in Hamilton </h1>
    <div id="themes-list">Themes</div>
    <div id="div1">  </div>
    <div id="div2"> </div>
    
    <div id="info_panel"> </div>

    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script>

    d3.csv("output.csv", function(data) {

    // Theme Name 	Song Name	Start Timestamp (mm:ss)	End Timestamp (mm:ss)	Time Start (sec)	Time End (sec)	Length (sec)  Song Number,    Total Start Seconds
    // data =  [
    // ["none", "", "", "", 0, 3, 3, 1, 0 ],
    // ["How Does",	"Alexander Hamilton",	"0:00:03",	"0:00:18",	3,	18,	16, 1, 3],
    // ["none", "", "", "", 18, 77, 77-18, 1, 18 ],
    // ["Alexander Hamilton",	"Alexander Hamilton",	"0:01:17",	"0:01:32",	77,	92,	16, 1, 77],
    // ["none", "", "", "", 92, 153, 153-92, 1, 92],
    // ["In New York",	"Alexander Hamilton",	"0:02:33",	"0:02:44",	153,	164,	12, 1, 153],
    // ["Alexander Hamilton",	"Alexander Hamilton",	"0:02:45",	"0:03:56",	165,	236,	72, 1, 165],

    // ["none", "", "", "", 0, 13, 13, 2, 236+0 ],
    // ["Aaron Burr, Sir",	"Aaron Burr, Sir",	"0:00:13",	"0:00:36",	13,	36,	24,  2, 236+13],
    // ["none", "", "", "", 36, 58, 22, 2, 236+36 ],
    // ["Talk Less, Smile More",	"Aaron Burr, Sir",	"0:00:58",	"0:01:30",	58,	90,	33, 2, 236+58],
    // ["none", "", "", "", 90, 137, 47, 2, 236+90 ],
    // ["Stand For Nothing",	"Aaron Burr, Sir",	"0:02:17",	"0:02:31",	137,	151,	15, 2, 236+137]
    // ];

    //secondary data set: 
    //name, index, start seconds
    // songs = [["Alexander Hamilton", 1, 0], ["Aaron Burr, Sir", 2, 236]];

    var unique_themes = [];
    data.forEach(function(datum) {
        // console.log(datum.theme_name);
        if (unique_themes.indexOf(datum.theme_name) == -1) {
            unique_themes.push(datum.theme_name);
        }
    });
    // console.log(unique_themes);
    console.log("numthemes: ", unique_themes.length);

    var unique_songs = [];
    var songs = [];
    data.forEach(function(datum) {
        console.log(datum.song_number);
        if (unique_songs.indexOf(datum.song_number) == -1) {
            unique_songs.push(datum.song_number);
            songs.push([datum.song_name, parseInt(datum.song_number, 10), parseInt(datum.total_start_sec, 10)]);
        }
    });

   var numSongs = songs.length;

    function print_themes(unique_themes) {
        var current_theme;
        for (var i = 0; i < unique_themes.length; i++) {
            d3.select("#themes-list")
                .append("div")
                    .on('mouseenter', function(d){
                        current_theme = this.textContent;
                        console.log(current_theme);

                        // find rects that have this theme and elongate_bar
                        d3.selectAll("rect").each(function(d, i){
                            if(d3.select(this).attr("theme") == current_theme){ 
                                elongate_bar(d, data, svg, false); 
                                hover_display(d, this.parentNode.id);          
                            }
                        })

                    })
                    .on('mouseleave', function(d) {
                        // console.log("theme reset");
                        d3.selectAll("rect").each(function(d, i){
                            if(d3.select(this).attr("theme") == current_theme){ 
                                reset_bar(d, data, svg, false);         
                            }
                        })
                    })
                .attr("class", "theme-item")
                .text(unique_themes[i]);
        }
    }
    print_themes(unique_themes);


    //setup 
    var window_change_height = 50;

    var barHeight = 40;

    var panel_showing = false;

    var panel_num = -1;

    var highlighted_theme;

    var standard_y = 10;

    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = window.innerWidth - 100,
        height = 500;


    //scaling
    var x = d3.scale.linear()
        .rangeRound([0, width]);

    x.domain([0, d3.max(data, function(d) { return parseInt(d.total_start_sec, 10) + parseInt(d.length_sec, 10); })]);

    var color = d3.scale.ordinal()
        // .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
        .range(["#bf0000", "#400000", "#cc6666", "#cc8166", "#4d3e39", "#4c1f00", "#f2853d", "#8c5b23", "#e5b073", "#ffaa00", "#332900", "#fff240", "#737156", "#adb359", "#6df23d", "#d0ffbf", "#1f5916", "#269954", "#1a3324", "#7ca692", "#39e6c3", "#00474d", "#39c3e6", "#004d73", "#40a6ff", "#001433", "#3056bf", "#737899", "#140099", "#5940ff", "#ff0044", "#8c0025", "#8c235b"]); 
        // http://phrogz.net/css/distinct-colors.html
    color.domain(d3.keys(data.theme_name));


    var x_pos_whole_musical = function(d) {
        console.log("place: ", x(parseInt(d.total_start_sec, 10)));
      return x(parseInt(d.total_start_sec, 10));
    };

    var x_pos_by_song = function(d) {
      return x(parseInt(d.start_sec, 10));
    };

    var y_pos_by_song = function(d) {
        var h = parseInt(d.song_number, 10)*100;
        if (panel_showing && panel_num < d.song_number) {
            h += 100;
        }
        console.log("Logging: ", d.song_number);
        return h;  
    };

    // var y_text_pos_by_song = function(d) {
    //     var h = d[1]*100 - 5;
    //     if (panel_showing && panel_num < d[1]) {
    //         h += 100;
    //     }
    //     return h;    
    // };

    var width_of_theme = function(d) {
      return x(parseInt(d.length_sec, 10)+1);
    };

    var y_pos_by_change = function(d, w) {
        // console.log((w - window_change_height)/100);
        // console.log(d[7] * height/(w - window_change_height));
        return d.song_number * (w - window_change_height);
    }


    function elongate_bar(d, data, svg, songs) {
            svg.selectAll("rect")
                .attr("class", "update")
                .transition()
                    .duration(750)
                        .attr("height", function(d1) {
                            if (d1.theme_name == d.theme_name && d.theme_name != "none") {
                                return barHeight + 20;
                            } else {
                                return barHeight;
                            }
                        })
                        .attr("y", function(d1) {
                            if (d1.theme_name == d.theme_name && d.theme_name != "none") {
                                if (songs) {
                                    return y_pos_by_song(d1) - 10;
                                }
                                return standard_y - 10; 
                            } else {
                                if (songs) {
                                    return y_pos_by_song(d1);
                                }
                                return standard_y;                             
                            }
                        });
    }

    function reset_bar(d, data, svg, songs) {
        svg.selectAll("rect")
            .attr("class", "update")
            .transition()
                .duration(750)
                    .attr("height", barHeight)
                    .attr("y", function(d1) {
                        if (songs) {
                            return y_pos_by_song(d1);
                        }
                        return standard_y; 
                    });
    }


    function hover_display(d, pid) {
        // console.log(d.theme_name);
        panel_showing = true;
        panel_num = d.song_number;

        //get rid of the old panel
        d3.select("#info_panel")
            .remove();

        var yoff = 70;
        // if (!transition_to_split) {
        //     yoff = (panel_num * 100) + 50;
        //  }

        if (d.theme_name != "none") {
            //insert a new panel
            d3.select("#" + pid)
                .append("g")
                    .attr("id", "info_panel")
                    .attr("transform", "translate(" + 0 + "," + yoff + ")")
                    .append("foreignObject")
                        .text("Theme: " + d.theme_name + " in Song:  " + d.song_name);
        }

    };

    //display data, starting in a single bar for the whole musical
    var svg = d3.select("#div1").append("svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    

        var g = svg.append("g")
            .attr("id", "g" + ns)
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        g.selectAll("rect")
            .data(data)
          .enter().append("rect")
            .attr("class", "enter")
            .attr("theme", function(d) { return d.theme_name; })
            .attr("width", function(d) {return width_of_theme(d);})
            .attr("x", function(d) { return x_pos_whole_musical(d); })
            .attr("y", standard_y)
            .attr("height", function(d) { return barHeight; })
            .style("fill", function(d) { return color(d.theme_name); })
            .on('mouseenter', function(d){
                elongate_bar(d, data, svg, false);
                hover_display(d, this.parentNode.id);
                // console.log(this.parentNode.id);


            })
            .on('mouseleave', function(d) {
                reset_bar(d, data, svg, false);
            });
    for (var ns = 1; ns <= numSongs; ns++) {
        g.selectAll("text")
            .data(songs)
          .enter().append("text")
            .filter(function(d) {
                return d[1] == ns;
            })
            .attr("x", function(d) { return d[2]; })
            .attr("y", standard_y-15)
            .text(function(d) { return d.theme_name ;})
    }


//display data, split by songs
    // var svg_songs = d3.select("#div2").append("svg")
    //     .attr("width", width)
    //     .attr("height", height)
    //   .append("g")
    //     .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    

    // for (var ns = 1; ns <= numSongs; ns++) {
    //     var g2 = svg_songs.append("g")
    //         .attr("id", "g" + ns)
    //         .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    //     g2.selectAll("rect")
    //         .data(data)
    //       .enter().append("rect")
    //         .attr("class", "enter")
    //         .filter(function(d) { 
    //           return d.song_number == ns;})
    //         .attr("width", function(d) {return width_of_theme(d);})
    //         .attr("x", function(d) { return x_pos_by_song(d); })
    //         .attr("y", function(d) { return y_pos_by_song(d); })
    //         .attr("height", function(d) { return barHeight; })
    //         .style("fill", function(d) { return color(d.theme_name); })
    //         .on('mouseenter', function(d){
    //             elongate_bar(d, data, svg_songs, true);
    //             hover_display(d, this.parentNode.id);
    //             console.log(this.parentNode.id);
    //         })
    //         .on('mouseleave', function(d) {
    //             reset_bar(d, data, svg_songs, true);
    //         });

    //     g2.selectAll("text")
    //         .data(songs)
    //       .enter().append("text")
    //         .filter(function(d) {
    //             return d[1] == ns;
    //         })
    //         .attr("x", function(d) { return d.start_timestamp; })
    //         .attr("y", function(d) { return y_pos_by_song(d)-15; })
    //         .text(function(d) { return d.theme_name ;})
    // }
});
    </script>
</body>
